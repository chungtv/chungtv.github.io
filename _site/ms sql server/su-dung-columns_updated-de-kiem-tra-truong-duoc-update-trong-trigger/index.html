<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Sử dụng COLUMNS_UPDATED() kiểm tra trường được update trong trigger</title>
  <meta name="description" content="  Đôi khi, vì lý do gì đó mà triger của bảng trong SQL Server bạn cần phải kiểm tra xem trường nào đang được update trước khi thực thi các lệnh tiếp theo. Xe..."> 
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://chungtrinh.com/ms%20sql%20server/su-dung-columns_updated-de-kiem-tra-truong-duoc-update-trong-trigger/">
  <link rel="alternate" type="application/rss+xml" title="Chung Trịnh's blog" href="http://chungtrinh.com/feed.xml" />

  

  <!--Start of Tawk.to Script-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/565950dcd6412f5177b912b3/default';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to Script-->
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Chung Trịnh's blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Sử dụng COLUMNS_UPDATED() kiểm tra trường được update trong trigger</h1>
    <p class="post-meta">Apr 24, 2015</p>
  </header>

  <article class="post-content">
    <blockquote>
  <p>Đôi khi, vì lý do gì đó mà triger của bảng trong SQL Server bạn cần phải kiểm tra xem trường nào đang được update trước khi thực thi các lệnh tiếp theo. <a href="https://trinhvanchung.wordpress.com/2010/11/03/s%e1%bb%ad-d%e1%bb%a5ng-columns_updated-d%e1%bb%83-ki%e1%bb%83m-tra-tr%c6%b0%e1%bb%9dng-d%c6%b0%e1%bb%a3c-update-trong-trigger/">Xem thêm bài viết này của tôi tại đây</a>. Bài này được tôi viết lại từ bài đó.</p>
</blockquote>

<blockquote>
  <p>Một phương pháp được tôi giới thiệu trong bài này là sử dụng <code class="highlighter-rouge">COLUMNS_UPDATED()</code>.</p>
</blockquote>

<p><img src="https://www.dropbox.com/s/90ymmfk4t8l036g/04-mssql_columns_updated.jpg?dl=1" alt="" /></p>

<h4 id="gii-thiu">Giới thiệu</h4>

<p>Về <code class="highlighter-rouge">COLUMNS_UPDATED()</code> các bạn có thể xem chi tiết ở <a href="https://msdn.microsoft.com/en-us/library/ms186329.aspx">site chính chủ</a>. Ở đây, tôi chỉ giới thiệu qua những điểm cơ bản.</p>

<p><code class="highlighter-rouge">COLUMNS_UPDATED()</code> là một Build-in Functions của SQL Server trả về một mẫu giá trị dạng nhị phân (varbinary bit pattern) để xác định vị trí cột nào được insert hoặc update. <code class="highlighter-rouge">COLUMNS_UPDATED()</code> thường được sử dụng trong INSERT hoặc UPDATE Trigger để kiểm tra vị trí cột được update nhằm xác định có hay không thực thi một số hành động nào đó.</p>

<p>Để kiểm tra vị trí cột nào được thay đổi chúng ta sử dụng các phép toán trên bit (bitwise operators) và bit mặt nạ (bitmask) tương ứng cho vị trí của mỗi cột.</p>

<h4 id="kim-tra-cc-ct-c-v-tr-8">Kiểm tra các cột có vị trí &lt;=8</h4>
<p>Kiểm tra cột tại vị trí n (n&lt;=8) có phải là cột thay đổi hay không thì sử dụng biểu thức sau:</p>

<p><code class="highlighter-rouge">sql
COLUMNS_UPDATED() &amp; Power(2,(n-1))
</code></p>

<p>Nếu biểu thức trả về &gt; 0 thì cột n là cột bị thay đổi, ngược lại cột n không thay đổi.</p>

<p>Trong trường hợp kiểm tra 2 hoặc nhiều cột có thay đổi hay không thì làm tương tự. Ví dụ kiểm tra cột 3 cột thứ i,j,k có thay đổi hay không (i,j,k&lt;=8) thì sử dụng biểu thức sau:</p>

<p><code class="highlighter-rouge">sql
COLUMNS_UPDATED() &amp; (Power(2,(i-1)) + Power(2,(j-1)) + Power(2,(k-1)))
</code></p>

<p><em>Chú ý: Để đỡ phải tính toán khi thực thi thì mình nên tính ra giá trị nguyên của các hàm <code class="highlighter-rouge">Power()</code> ở ngoài luôn rồi dùng kết quả đó để kiểm tra. Ví dụ thay vì viết như cách trên, mình viết như sau:</em></p>

<p><code class="highlighter-rouge">sql
COLUMNS_UPDATED() &amp; kq 
-- với kq = (Power(2,(i-1)) + Power(2,(j-1)) + Power(2,(k-1)))
</code></p>

<h4 id="kim-tra-cc-ct-c-v-tr-8-1">Kiểm tra các cột có vị trí &gt;8</h4>

<p>Sử dụng hàm <code class="highlighter-rouge">SUBSTRING()</code> cho giá trị trả về của <code class="highlighter-rouge">COLUMNS_UPDATED()</code>.</p>

<p>Ví dụ cần kiểm tra có update cột 10 hay không, sử dụng biểu thức sau:</p>

<p><code class="highlighter-rouge">sql
SUBSTRING(COLUMNS_UPDATED(),2,1) &amp; Power(2,(10-8-1))
</code></p>

<p>Còn nếu cột cần kiểm tra &gt; 16 thì làm tương tự. Ví dụ cần kiểm tra cột 19 có Update không thì sử dụng biểu thức:</p>

<p><code class="highlighter-rouge">sql
SUBSTRING(COLUMNS_UPDATED(),3,1) &amp; Power(2,(19-16-1))
</code></p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Chung Trịnh's blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Chung Trịnh's blog</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Personal website of Chung Trinh.</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
