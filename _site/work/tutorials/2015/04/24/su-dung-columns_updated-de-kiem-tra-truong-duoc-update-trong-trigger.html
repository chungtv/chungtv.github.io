<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Sử dụng COLUMNS_UPDATED() kiểm tra trường được update trong trigger</title>
  <meta name="author" content="Chung Trịnh" />  
  
  <link rel="canonical" href="/work/tutorials/2015/04/24/su-dung-columns_updated-de-kiem-tra-truong-duoc-update-trong-trigger.html">
  <link href="http://chungtrinh.com/feed.xml" type="application/atom+xml" rel="alternate" title="Chung Trịnh's Blog Feed">
  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
   <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" /> 
  
   <link rel="stylesheet" href="/css/bootstrap.min.css" /><link rel="stylesheet" href="/css/main.css" /> 
  
   <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" /><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /> 
  
  
  
  
  
  
  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:image" content="http://chungtrinh.com/img/logo.png">
  <meta name="twitter:title" content="Sử dụng COLUMNS_UPDATED() kiểm tra trường được update trong trigger">
  <meta name="twitter:description" content="Business Software Developer and Bloger!">
  <meta name="twitter:creator" content="@trinhvanchung">
  <!-- Open Graph -->
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
  <meta property="og:title" content="Sử dụng COLUMNS_UPDATED() kiểm tra trường được update trong trigger">
  <meta property="og:description" content="Business Software Developer and Bloger!">
  <meta property="og:url" content="http://chungtrinh.com/work/tutorials/2015/04/24/su-dung-columns_updated-de-kiem-tra-truong-duoc-update-trong-trigger.html/" />
    
  <meta property="og:site_name" content="Chung Trịnh's Blog">
  <meta property="og:image" content="http://chungtrinh.com/img/logo.png" />
  <!-- Icons -->
  <link rel="shortcut icon" href="http://chungtrinh.com/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="57x57" href="http://chungtrinh.com/img/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="http://chungtrinh.com/img/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="http://chungtrinh.com/img/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="http://chungtrinh.com/img/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="http://chungtrinh.com/img/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="http://chungtrinh.com/img/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="http://chungtrinh.com/img/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="http://chungtrinh.com/img/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="http://chungtrinh.com/img/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="http://chungtrinh.com/img/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="http://chungtrinh.com/img/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="http://chungtrinh.com/img/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="http://chungtrinh.com/img/android-chrome-192x192.png" sizes="192x192">
  <meta name="msapplication-square70x70logo" content="http://chungtrinh.com/img/smalltile.png" />
  <meta name="msapplication-square150x150logo" content="http://chungtrinh.com/img/mediumtile.png" />
  <meta name="msapplication-wide310x150logo" content="http://chungtrinh.com/img/widetile.png" />
  <meta name="msapplication-square310x310logo" content="http://chungtrinh.com/img/largetile.png" />
</head>


  <body>
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://chungtrinh.com/">Chung Trịnh's Blog</a>
    </div>
    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
           
        
          <li>
            
            





<a href="/">Home</a>

          </li>
        
        
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Categories</a>
            <div class="navlinks-children">
              
                
                  
            





<a href="/categories">All Categories</a>

                
              
                
                  
            





<a href="/categories#work">Works</a>

                
              
                
                  
            





<a href="/categories#life">Life</a>

                
              
                
                  
            





<a href="/categories#tutorials">Tutorials</a>

                
              
                
                  
            





<a href="/categories#tips-and-tricks">Tips & tricks</a>

                
              
            </div>
          </li>
        
        
        
          <li>
            
            





<a href="/tags">Tags</a>

          </li>
        
        
        
          <li>
            
            





<a href="/pages/tools">Tools</a>

          </li>
        
        
        
          <li>
            
            





<a href="/about">About</a>

          </li>
        
        
      </ul>
    </div>
	
	<div class="avatar-container">
	  <div class="avatar-img-border">
	    <a href="http://chungtrinh.com ">
	      <img class="avatar-img" src="/img/avatar.jpg" />
		</a>
	  </div>
	</div>
	
  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Sử dụng COLUMNS_UPDATED() kiểm tra trường được update trong trigger</h1>
		  
		  
		  
		  <span class="post-meta">Posted on April 24, 2015. Tagged:  <a href="/tags#ms-sql-server"> • Ms sql server</a></span>
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <article>
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <blockquote>
  <p>Đôi khi, vì lý do gì đó mà triger của bảng trong SQL Server bạn cần phải kiểm tra xem trường nào đang được update trước khi thực thi các lệnh tiếp theo. <a href="https://trinhvanchung.wordpress.com/2010/11/03/s%e1%bb%ad-d%e1%bb%a5ng-columns_updated-d%e1%bb%83-ki%e1%bb%83m-tra-tr%c6%b0%e1%bb%9dng-d%c6%b0%e1%bb%a3c-update-trong-trigger/">Xem thêm bài viết này của tôi tại đây</a>. Bài này được tôi viết lại từ bài đó.</p>
</blockquote>

<blockquote>
  <p>Một phương pháp được tôi giới thiệu trong bài này là sử dụng <code class="highlighter-rouge">COLUMNS_UPDATED()</code>.</p>
</blockquote>

<p><img src="https://www.dropbox.com/s/90ymmfk4t8l036g/04-mssql_columns_updated.jpg?dl=1" alt="" /></p>

<h4 id="gii-thiu">Giới thiệu</h4>

<p>Về <code class="highlighter-rouge">COLUMNS_UPDATED()</code> các bạn có thể xem chi tiết ở <a href="https://msdn.microsoft.com/en-us/library/ms186329.aspx">site chính chủ</a>. Ở đây, tôi chỉ giới thiệu qua những điểm cơ bản.</p>

<p><code class="highlighter-rouge">COLUMNS_UPDATED()</code> là một Build-in Functions của SQL Server trả về một mẫu giá trị dạng nhị phân (varbinary bit pattern) để xác định vị trí cột nào được insert hoặc update. <code class="highlighter-rouge">COLUMNS_UPDATED()</code> thường được sử dụng trong INSERT hoặc UPDATE Trigger để kiểm tra vị trí cột được update nhằm xác định có hay không thực thi một số hành động nào đó.</p>

<p>Để kiểm tra vị trí cột nào được thay đổi chúng ta sử dụng các phép toán trên bit (bitwise operators) và bit mặt nạ (bitmask) tương ứng cho vị trí của mỗi cột.</p>

<h4 id="kim-tra-cc-ct-c-v-tr-8">Kiểm tra các cột có vị trí &lt;=8</h4>
<p>Kiểm tra cột tại vị trí n (n&lt;=8) có phải là cột thay đổi hay không thì sử dụng biểu thức sau:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">COLUMNS_UPDATED</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">Power</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre>
</div>

<p>Nếu biểu thức trả về &gt; 0 thì cột n là cột bị thay đổi, ngược lại cột n không thay đổi.</p>

<p>Trong trường hợp kiểm tra 2 hoặc nhiều cột có thay đổi hay không thì làm tương tự. Ví dụ kiểm tra cột 3 cột thứ i,j,k có thay đổi hay không (i,j,k&lt;=8) thì sử dụng biểu thức sau:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">COLUMNS_UPDATED</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Power</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</code></pre>
</div>

<p><em>Chú ý: Để đỡ phải tính toán khi thực thi thì mình nên tính ra giá trị nguyên của các hàm <code class="highlighter-rouge">Power()</code> ở ngoài luôn rồi dùng kết quả đó để kiểm tra. Ví dụ thay vì viết như cách trên, mình viết như sau:</em></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">COLUMNS_UPDATED</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">kq</span> 
<span class="c1">-- với kq = (Power(2,(i-1)) + Power(2,(j-1)) + Power(2,(k-1)))
</span></code></pre>
</div>

<h4 id="kim-tra-cc-ct-c-v-tr-8-1">Kiểm tra các cột có vị trí &gt;8</h4>

<p>Sử dụng hàm <code class="highlighter-rouge">SUBSTRING()</code> cho giá trị trả về của <code class="highlighter-rouge">COLUMNS_UPDATED()</code>.</p>

<p>Ví dụ cần kiểm tra có update cột 10 hay không, sử dụng biểu thức sau:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">SUBSTRING</span><span class="p">(</span><span class="n">COLUMNS_UPDATED</span><span class="p">(),</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Power</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="mi">10</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre>
</div>

<p>Còn nếu cột cần kiểm tra &gt; 16 thì làm tương tự. Ví dụ cần kiểm tra cột 19 có Update không thì sử dụng biểu thức:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">SUBSTRING</span><span class="p">(</span><span class="n">COLUMNS_UPDATED</span><span class="p">(),</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Power</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="mi">19</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre>
</div>

    </div>
    </div>
  </article>
  
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
       <hr>
<h4>Share this:</h2>
<ul class="share-buttons">
  <li><a href="https://facebook.com/sharer.php?u=http://chungtrinh.com/work/tutorials/2015/04/24/su-dung-columns_updated-de-kiem-tra-truong-duoc-update-trong-trigger.html" title="Share on Facebook" target="_blank"><i class="fa fa-facebook fa-fw"></i></a></li>
  <li><a href="https://twitter.com/intent/tweet?text=Sử dụng COLUMNS_UPDATED() kiểm tra trường được update trong trigger&url=http://chungtrinh.com/work/tutorials/2015/04/24/su-dung-columns_updated-de-kiem-tra-truong-duoc-update-trong-trigger.html" target="_blank" title="Tweet"><i class="fa fa-twitter fa-fw"></i></a></li>
  <li><a href="https://plus.google.com/share?url=http://chungtrinh.com/work/tutorials/2015/04/24/su-dung-columns_updated-de-kiem-tra-truong-duoc-update-trong-trigger.html" target="_blank" title="Share on Google+"><i class="fa fa-google-plus fa-fw"></i></a></li>
</ul>
<hr>
    </div>
  </div>
  

  
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="/life/2015/04/16/thien-nhien-chan-hoa-trong-nha-ong-40-m2-o-ha-noi.html" data-toggle="tooltip" data-placement="top" title="Thiên nhiên chan hòa trong nhà ống 40 m2 ở Hà Nội">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="/work/tips%20and%20tricks/2015/04/24/luu-cau-hinh-ip-va-set-lai-khi-can-thiet-bang-dong-lenh.html" data-toggle="tooltip" data-placement="top" title="Lưu cấu hình IP Profile và thiết lập lại khi cần thiết">Next Post &rarr;</a>
        </li>
        
      </ul>
    </div>
  </div>

<div class="row disqus-comments">
  <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    var disqus_shortname = 'chungtrinh';
	    // ensure that pages with query string get the same discussion
            var url_parts = window.location.href.split("?");
            var disqus_url = url_parts[0];	    
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


  </div>
</div>

</div>


    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          <li>
            <a href="https://www.facebook.com/chungtv" title="Facebook" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://github.com/chungtv" title="GitHub" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
          <li>
            <a href="https://twitter.com/trinhvanchung" title="Twitter" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
          <li>
            <a href="mailto:aschungtv@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
		  
		  
		  <li>
			<a href="/feed.xml" title="RSS" target="_blank">
			  <span class="fa-stack fa-lg">
				<i class="fa fa-circle fa-stack-2x"></i>
				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
			  </span>
			</a>
		  </li>		
          		  
        </ul>
        <p class="copyright text-muted">
		  Chung Trịnh
		  &nbsp;&bull;&nbsp;
		  2016
		  
		  
		  &nbsp;&bull;&nbsp;
		  <a href="http://chungtrinh.com">chungtrinh.com</a>
		  
	    </p>
	        <!-- Please don't remove this, keep my open source work credited :) -->
		<p class="theme-by text-muted">
		  Theme by
		  <a href="http://deanattali.com/beautiful-jekyll/"  target="_blank">beautiful-jekyll</a>
		</p>
      </div>
    </div>
  </div>
</footer>

  
    <!-- everything has to be repeated twice because on 2016-02-01 GitHub pages migrated to jekyll 3; see bug https://github.com/jekyll/jekyll/issues/4439 -->











  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/main.js"></script>
    
  




	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-62079859-1', 'auto');
		ga('send', 'pageview');
	</script>
	<!-- End Google Analytics -->


  
  </body>
</html>
